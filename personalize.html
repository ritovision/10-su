---
layout: null
---
<!doctype html>
<html lang="en" class="personalize-page">

<head>
  <script>window.SITE_BASEURL = "{{ site.baseurl }}";</script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  {% include pwa-meta-tags.html %}
  <title>Su Squares, personalize</title>
  <link rel="canonical" href="https://tenthousandsu.com/personalize" />
  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="stylesheet" href="assets/css/personalize.css">
  <link rel="stylesheet" href="assets/web3/tx/styles.css">
  {% include nav-menu-head.html %}
  {% include alert-modal-head.html %}
  {% include offline-modal-head.html %}
</head>

<body>
  {% include nav-header.html desktop_button_one_label="Mint" desktop_button_one_href="/buy" %}

  <article class="lead">
    <h1>Personalize</h1>
    <p>
      <em>If you have any questions, please mail <a
          href="mailto:Su@TenThousandSu.com?subject=Personalize+underlay+batch">Su@TenThousandSu.com</a>. The price to
        personalize is 0.001 Ether.</em>
    </p>
    <p>
      Use this page to personalize a Su Square you own on TenThousandSu.com. To personalize many squares, try the <a
        href="personalize-batch">batch tool</a>. If your Square was previously personalized using the old, more
      expensive method you will need to <a href="https://tools.tenthousandsu.com/unpersonalize.html">unpersonalize</a>
      it first.
    </p>

    <h2>Select a Square</h2>
    <p>Which Square will you personalize?</p>
    <p>
      <input id="square-number" type="number" min="1" max="10000" required style="width:7em" placeholder="e.g. 7421">
    </p>

    <h2>Enter title</h2>
    <p>Enter a title for your Square.</p>
    <p>
      <input id="title" type="text" maxlength="64" placeholder="e.g. My Su Square">
    </p>
    <p><span id="title-count">0</span> of 64 bytes</p>

    <h2>Enter URL</h2>
    <p>Enter a URL for your Square. Typically this will start with <code>https://</code>.</p>
    <p>
      <input id="url" type="text" maxlength="96" placeholder="e.g. https://example.com">
    </p>
    <p><span id="url-count">0</span> of 96 bytes</p>

    <h2>Upload image</h2>
    <p>Design your image carefully to be 10&times;10 pixels.</p>
    <p>Do not use animation or transparency. PNG and some other formats can be used here.</p>
    <p>
      <input id="image" type="file" accept="image/png, image/jpeg, image/gif">
    </p>
    <p>
      Image status: <span id="image-status">no image selected</span>
    </p>
    <p>
      <canvas id="image-preview" style="width:0;height:0;image-rendering:pixelated;"></canvas>
    </p>

    <h2>Personalize</h2>
    <p>Click this button to personalize your Square.</p>
    <div class="wallet-actions">
      <button id="open-wallet-app" type="button" class="btn">Open mobile wallet</button>
      <button id="personalize" class="btn btn-lg">Personalize</button>
    </div>

    <div id="tx-fixture"></div>
  </article>

  <footer>
    <small>
      No cookies. No analytics. To the extent possible under law, Su Entriken has waived all copyright and related or
      neighboring rights to the TenThousandSu.com website. This work is published from the United States.
    </small>
  </footer>

  <script type="module">
    import {
      ensureConnected,
      ensureCorrectNetwork,
      openWalletFromStore,
      hasWalletConnectSession,
    } from "{{ site.baseurl }}/assets/web3/foundation.js";
    import { createTxFixture } from "{{ site.baseurl }}/assets/web3/tx/index.js";
    import { getWeb3Config } from "{{ site.baseurl }}/assets/web3/config.js";
    import { personalizeUnderlay } from "{{ site.baseurl }}/assets/web3/services/underlay.js";
    import { buildTxUrl } from "{{ site.baseurl }}/assets/web3/services/explorer-links.js";

    // Elements and state //////////////////////////////////////////////////////////////////////////////////////////////
    const squareNumberInput = document.getElementById("square-number");
    const titleInput = document.getElementById("title");
    const titleCountSpan = document.getElementById("title-count");
    const urlInput = document.getElementById("url");
    const urlCountSpan = document.getElementById("url-count");
    const imageInput = document.getElementById("image");
    const imageStatusSpan = document.getElementById("image-status");
    const imagePreviewCanvas = document.getElementById("image-preview");
    const openWalletButton = document.getElementById("open-wallet-app");
    const personalizeButton = document.getElementById("personalize");
    const txFixtureDiv = document.getElementById("tx-fixture");
    const { pricing } = getWeb3Config();
    const txUi = createTxFixture({
      target: txFixtureDiv,
      pricing,
      title: "Personalization status",
    });
    let squareNumber;
    let title;
    let url;
    let imagePixelsHex; // 0xRRGGBB.. of top-left pixel, pixel to its right, ...

    // Validate changes to #square-number //////////////////////////////////////////////////////////////////////////////
    // todo: look up and show warnings if Square is personalized on main contract (which occludes)
    squareNumberInput.addEventListener("input", (event) => {
      squareNumber = null;
      const value = parseInt(event.target.value);
      if (isNaN(value) || value < 1 || value > 10000) {
        return alert("Invalid Square number, please enter a number between 1 and 10000.");
      }
      squareNumber = value;
    });

    // Validate changes to #title //////////////////////////////////////////////////////////////////////////////////////
    titleInput.addEventListener("input", (event) => {
      title = null;
      const length = new TextEncoder().encode(event.target.value).length; // UTF-8 byte length
      titleCountSpan.innerText = length;
      if (length > 64) {
        return alert("Title is too long, please try again.");
      }
      if (length < 1) {
        return alert("Title is too short, please try again.");
      }
      title = event.target.value;
    });

    // Validate changes to #url ////////////////////////////////////////////////////////////////////////////////////////
    urlInput.addEventListener("input", (event) => {
      url = null;
      const length = new TextEncoder().encode(event.target.value).length; // UTF-8 byte length
      urlCountSpan.innerText = length;
      if (length > 96) {
        return alert("URL is too long, please try again.");
      }
      if (length < 1) {
        return alert("URL is too short, please try again.");
      }
      url = event.target.value;
    });

    // Validate changes to #image //////////////////////////////////////////////////////////////////////////////////////
    imageInput.addEventListener("change", (event) => {
      imagePixelsHex = null;
      imageStatusSpan.innerText = "Loading image…";
      imagePreviewCanvas.width = 0;
      imagePreviewCanvas.height = 0;
      if (!event.target.files || !event.target.files[0]) {
        imageStatusSpan.innerText = "No image selected";
        imageInput.value = "";
        return alert("Unable to read file");
      }
      const image = new Image();
      image.addEventListener("load", () => {
        if (image.width !== 10 || image.height !== 10) {
          imageStatusSpan.innerText = "No image selected";
          imageInput.value = "";
          return alert("IMAGE ERROR: Image must be 10×10 pixels. Please try again.");
        }
        if (image.naturalWidth !== image.width || image.naturalHeight !== image.height) {
          imageStatusSpan.innerText = "No image selected";
          imageInput.value = "";
          return alert("IMAGE ERROR: Image must not be animated. Please try again.");
        }
        imagePreviewCanvas.width = 10;
        imagePreviewCanvas.height = 10;
        const context = imagePreviewCanvas.getContext("2d");
        context.drawImage(image, 0, 0);
        const contextImageData = context.getImageData(0, 0, 10, 10);
        let alphaWarning = false;
        imagePixelsHex = "0x";
        for (let i = 0; i < contextImageData.data.length; i += 4) {
          const [red, green, blue, alpha] = contextImageData.data.slice(i, i + 4);
          // Mix color to a white background (255) if there is transparency
          const mixedRed = Math.floor((red * alpha + 255 * (255 - alpha)) / 255);
          const mixedGreen = Math.floor((green * alpha + 255 * (255 - alpha)) / 255);
          const mixedBlue = Math.floor((blue * alpha + 255 * (255 - alpha)) / 255);
          if (alpha != 255) alphaWarning = true;
          imagePixelsHex += mixedRed.toString(16).padStart(2, "0");
          imagePixelsHex += mixedGreen.toString(16).padStart(2, "0");
          imagePixelsHex += mixedBlue.toString(16).padStart(2, "0");
        }
        if (alphaWarning) {
          alert("WARNING: Your image included transparency. Since Su Squares does not support transparency, we have mixed down this color on top of a white background. Proceed at your own risk.");
        }
        imageStatusSpan.innerText = "Image loaded, shown here enlarged";
        imagePreviewCanvas.style.width = "100px";
        imagePreviewCanvas.style.height = "100px";
      });
      image.src = window.URL.createObjectURL(event.target.files[0]);
    });

    // Handle ?square= query parameter /////////////////////////////////////////////////////////////////////////////////
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has("square")) {
      squareNumberInput.value = urlParams.get("square");
      squareNumberInput.dispatchEvent(new Event("input"));
    }

    const updateOpenWalletButton = () => {
      if (!openWalletButton) return;
      const hasSession = hasWalletConnectSession();
      openWalletButton.style.display = hasSession ? "inline-block" : "none";
    };

    const triggerWalletDeepLink = () => {
      if (hasWalletConnectSession()) {
        openWalletFromStore();
      }
    };

    if (openWalletButton) {
      updateOpenWalletButton();
      window.addEventListener("su-wc-session-change", (event) => {
        const hasSession = Boolean(event?.detail?.hasSession);
        openWalletButton.style.display = hasSession ? "inline-block" : "none";
      });
      openWalletButton.addEventListener("click", () => {
        if (!openWalletFromStore()) {
          alert("No WalletConnect session found yet. Tap Connect Wallet first.");
        }
      });
    }

    // Handle personalize button ///////////////////////////////////////////////////////////////////////////////////////
    personalizeButton.addEventListener("click", async () => {
      if (!squareNumber) {
        return alert("Please enter a Square number.");
      }
      if (!title) {
        return alert("Please enter a title.");
      }
      if (!url) {
        return alert("Please enter a URL.");
      }
      if (!imagePixelsHex) {
        return alert("Please select an image.");
      }
      triggerWalletDeepLink();
      txUi.startProcessing(`Personalizing Square #${squareNumber}. Confirm in your wallet to continue.`);
      const doSendTransaction = async (wagmi) => {
        txUi.setWalletContext({
          hasSession: hasWalletConnectSession(),
          isWalletConnect: wagmi?.getAccount?.()?.connector?.id === "walletConnect",
        });
        let result;
        try {
          result = await personalizeUnderlay({ squareId: squareNumber, imagePixelsHex, title, url }, wagmi);
          const pendingUrl = buildTxUrl(result.hash);
          txUi.addPending(result.hash, pendingUrl);
          const transaction = await wagmi.waitForTransaction({ hash: result.hash });
          const txUrl = buildTxUrl(transaction.transactionHash);
          txUi.markSuccess(
            transaction.transactionHash,
            txUrl,
            "Transaction confirmed. Your image will show on the Su Squares homepage, which refreshes hourly."
          );
        } catch (error) {
          console.log(error);
          txUi.markError(error?.message || "Transaction failed");
          return alert(error?.message || "Transaction failed");
        }
      };
      await ensureConnected(async (clients) => {
        await ensureCorrectNetwork(clients);
        await doSendTransaction(clients);
      });
    });
  </script>
  <script src="{{ site.baseurl }}/assets/js/pwa-init.js"></script>
</body>

</html>